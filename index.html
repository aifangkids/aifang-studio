<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIFANGKIDS | Studio</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    
    <style>
        /* --- 1. 字體與基礎設定 --- */
        @font-face { font-family: 'NotoSansKR'; src: url('./fonts/NotoSansKR-Thin.ttf') format('truetype'); font-weight: 100; }
        @font-face { font-family: 'NotoSansKR'; src: url('./fonts/NotoSansKR-Light.ttf') format('truetype'); font-weight: 300; }
        @font-face { font-family: 'NotoSansKR'; src: url('./fonts/NotoSansKR-Regular.ttf') format('truetype'); font-weight: 400; }
        @font-face { font-family: 'NotoSansKR'; src: url('./fonts/NotoSansKR-Medium.ttf') format('truetype'); font-weight: 500; }

        :root { 
            --sidebar-width: 260px; 
            --accent: #d9534f; 
            --new-color: #a29bfe; 
            --header-h: 70px; 
            --cart-w: 380px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'NotoSansKR', 'Noto Sans TC', sans-serif; background: #fff; color: #333; 
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
        }

        /* --- 2. 頂部導覽 (優化搜尋與訂單按鈕) --- */
        .top-header {
            width: 100%; height: var(--header-h); background: #fff;
            position: fixed; top: 0; left: 0; z-index: 1200;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; border-bottom: 1px solid #f2f2f2;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .header-right { display: flex; align-items: center; gap: 20px; flex: 1; justify-content: flex-end; }
        
        /* 搜尋框樣式 */
        .search-wrap { position: relative; display: flex; align-items: center; }
        #search-input {
            border: 1px solid #eee; padding: 6px 10px; font-size: 11px;
            width: 150px; outline: none; transition: 0.3s;
            font-family: 'NotoSansKR'; letter-spacing: 1px;
        }
        #search-input:focus { width: 200px; border-color: #ccc; }

        .header-icon { width: 22px; height: 22px; cursor: pointer; object-fit: contain; }
        .main-logo { height: 32px; cursor: pointer; position: absolute; left: 50%; transform: translateX(-50%); }

        /* --- 3. 側欄佈局 --- */
        .sidebar {
            width: var(--sidebar-width); height: 100vh; position: fixed;
            left: 0; top: 0; border-right: 1px solid #eee;
            padding: calc(var(--header-h) + 40px) 30px 50px; background: #fff; z-index: 1100; overflow-y: auto;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .filter-title { 
            font-size: 11px; font-weight: 700; letter-spacing: 2px; 
            margin-bottom: 20px; text-transform: uppercase; 
            border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; color: #111;
        }
        .category-menu { list-style: none; }
        .category-menu li { font-size: 13px; font-weight: 400; margin-bottom: 15px; color: #888; cursor: pointer; transition: 0.3s; }
        .category-menu li:hover, .category-menu li.active { color: #000; font-weight: 500; text-decoration: underline; }

        .brand-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; background: #fafafa; padding: 0 10px; border-radius: 4px; }
        .brand-panel.open { max-height: 500px; padding: 15px 10px; margin-bottom: 20px; }
        .brand-item { 
            display: block; font-size: 11px; font-weight: 300; 
            color: #999; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .brand-item.selected { color: #000; font-weight: 700; }

        /* --- 4. 主內容區與商品卡 --- */
        .main-content { 
            width: 100%; 
            padding: calc(var(--header-h) + 40px) 40px 80px calc(var(--sidebar-width) + 40px); 
            transition: opacity 0.8s ease; opacity: 0; 
        }
        .main-content.loaded { opacity: 1; }

        .product-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 40px 20px; }
        .product-card { cursor: pointer; text-align: left; } 
        
        .img-wrap { 
            width: 100%; aspect-ratio: 3/4; background-size: cover; background-position: center; 
            background-color: #f9f9f9; margin-bottom: 15px; position: relative; overflow: hidden;
            border-radius: 4px;
        }
        .status-badge { 
            position: absolute; top: 10px; left: 10px; padding: 4px 8px; 
            font-size: 9px; font-weight: 700; color: #fff; z-index: 10;
        }
        .badge-NEW { background: var(--new-color); }
        .badge-SALE { background: var(--accent); }

        .p-name { font-size: 12px; font-weight: 400; color: #333; margin-bottom: 6px; height: 36px; overflow: hidden; line-height: 1.5; }
        
        .color-row { display: flex; justify-content: flex-start; gap: 4px; margin: 8px 0; flex-wrap: wrap; min-height: 14px; }
        .color-dot { 
            width: 12px; height: 12px; border: 1px solid #eee; border-radius: 2px; 
            background-size: cover; background-position: center; cursor: help;
        }
        
        .p-price { font-size: 13px; font-weight: 700; color: #111; }

        /* --- 5. 工具組 --- */
        .fixed-tools { position: fixed; bottom: 30px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 0; }
        .tool-btn { 
            width: 45px; height: 45px; background: #fff; border: 1px solid #333; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.3s;
            margin-bottom: -1px; 
        }
        .tool-btn:hover { background: #333; color: #fff; }
        .line-btn { background: #fff; color: #06C755; }
        .line-btn:hover { background: #06C755; color: #fff; border-color: #06C755; }

        /* --- 6. 購物車側欄 --- */
        #cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2999; display: none; }
        .cart-sidebar {
            position: fixed; top: 0; right: calc(var(--cart-w) * -1); width: var(--cart-w); height: 100vh; background: #fff;
            z-index: 3000; display: flex; flex-direction: column; transition: transform 0.4s ease;
        }
        .cart-sidebar.open { transform: translateX(calc(var(--cart-w) * -1)); }
        .cart-header { padding: 30px 25px; border-bottom: 1px solid #f2f2f2; display: flex; justify-content: space-between; align-items: center; }
        .cart-title { font-size: 13px; font-weight: 700; letter-spacing: 2px; }
        .cart-close { font-size: 11px; color: #111; cursor: pointer; text-decoration: underline; font-weight: bold; }
        .cart-body { flex: 1; padding: 25px; overflow-y: auto; }
        .cart-footer { padding: 25px; border-top: 1px solid #f2f2f2; }
        .checkout-btn { width: 100%; padding: 18px; background: #111; color: #fff; border: none; cursor: pointer; font-size: 12px; font-weight: 700; letter-spacing: 2px; }

        /* --- 7. POPUP 彈窗 --- */
        #popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .popup-box { position: relative; background: #fff; max-width: 380px; width: 85%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .popup-close { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: #fff; cursor: pointer; font-size: 12px; border: 1px solid #fff; padding: 5px 20px; white-space: nowrap; }

        /* --- 8. 手機版響應式 --- */
        @media (max-width: 900px) {
            .header-left { flex: 1.5; }
            #search-input { width: 100px; font-size: 10px; }
            #search-input:focus { width: 120px; }
            .header-right { gap: 12px; }
            
            .sidebar { transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .main-content { padding: calc(var(--header-h) + 30px) 15px 80px 15px; }
            .product-grid { grid-template-columns: repeat(2, 1fr); gap: 25px 12px; }
            .cart-sidebar { width: 100%; right: -100%; }
            .main-logo { height: 28px; }
            .fixed-tools { bottom: 20px; right: 15px; }
        }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1050; display: none; }
        .sidebar-overlay.active { display: block; }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="header-left">
            <img src="./images/ui/menu.png" class="header-icon" onclick="toggleMenu()" alt="Menu">
            <div class="search-wrap">
                <input type="text" id="search-input" placeholder="SEARCH CODE / NAME" oninput="handleSearch(this.value)">
            </div>
        </div>

        <img src="./images/ui/logo.png" class="main-logo" onclick="location.reload()" alt="AIFANGKIDS">
        
        <div class="header-right">
            <img src="./images/ui/order.png" class="header-icon" onclick="location.href='order_query.html'" alt="Order">
            <img src="./images/ui/icon_tcart.png" class="header-icon" onclick="toggleCart()" alt="Cart">
        </div>
    </header>

    <div id="overlay" class="sidebar-overlay" onclick="closeMenu()"></div>

    <div id="popup-overlay">
        <div class="popup-box">
            <img id="popup-img" style="width:100%; display:block; object-fit: contain;">
            <div class="popup-close" onclick="closePopup()">CLOSE [X]</div>
        </div>
    </div>

    <div class="fixed-tools">
        <div class="tool-btn" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">TOP</div>
        <div class="tool-btn line-btn" onclick="window.open('https://line.me/R/ti/p/@844bwwjl', '_blank')">LINE</div>
    </div>

    <aside id="sidebar" class="sidebar">
        <div class="filter-section">
            <p class="filter-title">Category</p>
            <ul class="category-menu">
                <li onclick="filterByCat('All')" class="active">ALL ITEMS</li>
                <li onclick="filterByCat('TOP')">TOP</li>
                <li onclick="filterByCat('BOTTOM')">BOTTOM</li>
                <li onclick="filterByCat('SET')">SET</li>
                <li onclick="filterByCat('OUTRE')">OUTRE</li>
                <li onclick="filterByCat('BEBE')">BEBE</li>
                <li onclick="filterByCat('FAMILY')">FAMILY</li>
                <li onclick="filterByCat('ACC')">ACC</li>
            </ul>
        </div>
        <div id="brand-area" class="brand-panel">
            <p class="filter-title" style="font-size: 10px; border:none; margin-top:10px;">Select Brand</p>
            <div id="brand-list"></div>
        </div>
    </aside>

    <div id="cart-overlay" onclick="toggleCart()"></div>
    <aside id="cart-sidebar" class="cart-sidebar">
        <div class="cart-header">
            <span class="cart-title">SHOPPING BAG</span>
            <span class="cart-close" onclick="toggleCart()">CLOSE</span>
        </div>
        <div id="mini-cart-body" class="cart-body"></div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-weight:700; font-size:14px;">
                <span>TOTAL</span>
                <span id="mini-cart-total">NT$ 0</span>
            </div>
            <button class="checkout-btn" onclick="location.href='cart.html'">VIEW CART & CHECKOUT</button>
        </div>
    </aside>

    <main id="main-content" class="main-content">
        <div id="product-list" class="product-grid"></div>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxnlAwKJucHmCKcJwv67TWuKV0X74Daag9X9I4NG7DOESREuYdU7BtWBPcEHyoJphoEfg/exec"; 
        let allData = [];
        let activeCat = 'All';
        let activeBrands = new Set();

        async function fetchData() {
            showRandomPopup();
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                allData = json.products || []; 
                render(allData);
                document.getElementById('main-content').classList.add('loaded');
            } catch (e) { console.error("API Error:", e); }
        }

        // --- 搜尋邏輯整合 ---
        function handleSearch(query) {
            const q = query.toLowerCase().trim();
            if (!q) {
                // 如果搜尋框清空，回復到目前分類的顯示狀態
                const currentFiltered = activeCat === 'All' ? allData : allData.filter(p => p.category === activeCat);
                render(currentFiltered);
                return;
            }
            // 搜尋所有商品中的 code 或 name
            const filtered = allData.filter(p => 
                (p.code && p.code.toLowerCase().includes(q)) || 
                (p.name && p.name.toLowerCase().includes(q))
            );
            render(filtered);
        }

        function render(items) {
            const container = document.getElementById('product-list');
            container.innerHTML = "";
            if(items.length === 0) {
                container.innerHTML = "<p style='grid-column: 1/-1; text-align:center; padding: 50px; color:#999;'>Coming Soon...</p>";
                return;
            }
            items.forEach(item => {
                const status = (item.status || "").toUpperCase();
                const badgeHtml = status ? `<span class="status-badge badge-${status}">${status}</span>` : "";
                
                const names = item.color ? item.color.toString().split(',').filter(Boolean) : [];
                const codes = item.color_code ? item.color_code.toString().split(',').filter(Boolean) : [];
                const patterns = item.color_pattern ? item.color_pattern.toString().split(',').filter(Boolean) : [];

                let colorHtml = '<div class="color-row">';
                names.forEach((name, index) => {
                    const hex = (codes[index] || "").trim();
                    const patternImg = (patterns[index] || "").trim();
                    let style = "";
                    if (patternImg) {
                        style = `background-image: url('${patternImg}');`;
                    } else if (hex.startsWith('#')) {
                        style = `background-color: ${hex};`;
                    }
                    if (style) {
                        colorHtml += `<div class="color-dot" title="${name.trim()}" style="${style}"></div>`;
                    }
                });
                colorHtml += '</div>';

                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => location.href = `detail.html?code=${item.code}`;
                card.innerHTML = `
                    <div class="img-wrap" style="background-image: url('${item.image_main}')">${badgeHtml}</div>
                    <div class="info-wrap">
                        <p class="p-name">${item.name}</p>
                        ${colorHtml}
                        <p class="p-price">NT$ ${Number(item.price_kid || 0).toLocaleString()}</p>
                    </div>`;
                container.appendChild(card);
            });
        }

        function filterByCat(cat) {
            activeCat = cat; activeBrands.clear();
            document.getElementById('search-input').value = ""; // 切換分類時清空搜尋
            document.querySelectorAll('.category-menu li').forEach(li => li.classList.toggle('active', li.innerText === cat));
            const filtered = cat === 'All' ? allData : allData.filter(p => p.category === cat);
            const area = document.getElementById('brand-area');
            if(cat === 'All') { area.classList.remove('open'); } 
            else {
                area.classList.add('open');
                const brands = [...new Set(filtered.map(p => p.brand))].filter(b => b);
                document.getElementById('brand-list').innerHTML = brands.map(b => 
                    `<div class="brand-item" onclick="toggleBrand(event, '${b}')" id="b-${b}">${b}</div>`).join('');
            }
            render(filtered);
            if(window.innerWidth <= 900) closeMenu();
        }

        function toggleBrand(e, b) {
            e.stopPropagation();
            const el = document.getElementById(`b-${b}`);
            if(activeBrands.has(b)) { activeBrands.delete(b); el.classList.remove('selected'); } 
            else { activeBrands.add(b); el.classList.add('selected'); }
            let final = allData.filter(p => p.category === activeCat);
            if(activeBrands.size > 0) final = final.filter(p => activeBrands.has(p.brand));
            render(final);
        }

        function toggleCart() {
            const cartSide = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('cart-overlay');
            const isOpen = cartSide.classList.toggle('open');
            overlay.style.display = isOpen ? 'block' : 'none';
            if (isOpen) renderMiniCart();
        }

        function renderMiniCart() {
            const cartData = JSON.parse(localStorage.getItem('cart')) || [];
            const container = document.getElementById('mini-cart-body');
            let total = 0;
            if(cartData.length === 0) {
                container.innerHTML = "<p style='text-align:center; padding:40px; color:#bbb; font-size:12px;'>Bag is empty</p>";
                document.getElementById('mini-cart-total').innerText = `NT$ 0`;
                return;
            }
            container.innerHTML = cartData.map(item => {
                total += item.price * item.quantity;
                return `<div style="display:flex; gap:15px; margin-bottom:20px; font-size:12px; align-items:center;">
                    <img src="${item.image}" width="60" style="border-radius:2px; aspect-ratio:1/1; object-fit:cover;">
                    <div style="flex:1;">
                        <p style="font-weight:700; margin-bottom:3px;">${item.name}</p>
                        <p style="color:#888;">${item.color} / ${item.size}</p>
                        <p style="margin-top:2px;">${item.quantity} x NT$ ${item.price.toLocaleString()}</p>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('mini-cart-total').innerText = `NT$ ${total.toLocaleString()}`;
        }

        function toggleMenu() { 
            document.getElementById('sidebar').classList.add('open'); 
            document.getElementById('overlay').classList.add('active'); 
        }
        function closeMenu() { 
            document.getElementById('sidebar').classList.remove('open'); 
            document.getElementById('overlay').classList.remove('active'); 
        }
        function showRandomPopup() {
            const pops = ['./images/popup/popup_01.jpg'];
            const randomPop = pops[Math.floor(Math.random() * pops.length)];
            const popImg = document.getElementById('popup-img');
            if(popImg) {
                popImg.src = randomPop;
                document.getElementById('popup-overlay').style.display = 'flex';
            }
        }
        function closePopup() { document.getElementById('popup-overlay').style.display = 'none'; }

        window.onload = fetchData;
    </script>
</body>
</html>