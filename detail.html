<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail | AiFang Kids</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <style>
        :root { --header-h: 70px; --side-w: 420px; --baby-pink: #f2a6b2; --kids-blue: #8da9c4; --accent: #d9534f; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #fff; color: #333; overflow-x: hidden; line-height: 1.6; }

        /* Header */
        .top-header { width: 100%; height: var(--header-h); background: #fff; position: fixed; top: 0; left: 0; z-index: 2000; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; border-bottom: 1px solid #f2f2f2; }
        .main-logo { height: 30px; cursor: pointer; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-icon { font-size: 13px; font-weight: bold; cursor: pointer; text-decoration: none; color: #333; letter-spacing: 1px; }

        /* Layout */
        .detail-wrapper { display: flex; max-width: 1400px; margin: var(--header-h) auto 0; position: relative; }
        .scroll-content { flex: 1; padding: 40px; border-right: 1px solid #f2f2f2; min-height: 100vh; }
        #image-main-area img { width: 100%; border-radius: 4px; display: block; margin-bottom: 20px; background: #f9f9f9; height: auto; }

        /* Fixed Aside Info */
        .fixed-aside { 
            width: var(--side-w); 
            position: sticky; 
            top: var(--header-h); 
            align-self: flex-start; 
            padding: 30px 40px; 
            background: #fff; 
        }

        @media (min-width: 901px) {
            .fixed-aside {
                max-height: calc(100vh - var(--header-h));
                overflow-y: auto;
                scrollbar-width: none;
            }
            .fixed-aside::-webkit-scrollbar { display: none; }
        }

        .brand-tag { font-size: 11px; font-weight: 500; letter-spacing: 1px; text-decoration: underline; margin-bottom: 8px; color: #555; display: block; }
        .p-title { font-size: 24px; font-weight: 500; margin-bottom: 10px; color: #111; line-height: 1.4; word-break: break-word; }
        .p-id { font-size: 11px; color: #bbb; margin-bottom: 25px; }
        .label { font-size: 10px; font-weight: 900; color: #aaa; margin: 25px 0 10px; display: block; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid #f2f2f2; padding-bottom: 5px; }

        /* 價格樣式 */
        .price-row { display: flex; flex-direction: column; gap: 2px; }
        .price-main { display: flex; gap: 8px; align-items: baseline; }
        .original-price { text-decoration: line-through; color: #bbb; font-weight: 400; font-size: 11px; }
        .sale-price { color: var(--accent); font-weight: 700; }
        .sale-badge { font-size: 10px; color: var(--accent); font-weight: bold; }

        /* 手機版預覽框 */
        .mobile-preview-box {
            display: none; align-items: center; gap: 12px; padding: 10px;
            background: #fdfdfd; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px;
        }
        #mobile-color-preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #f0f0f0; }
        #mobile-color-preview-name { font-size: 14px; font-weight: 700; color: #333; }

        /* 選取按鈕 */
        .swatch-group { display: flex; flex-wrap: wrap; gap: 8px; }
        .swatch-item { cursor: pointer; display: flex; align-items: center; padding: 6px 12px; border: 1px solid #ddd; border-radius: 20px; transition: 0.2s; font-size: 13px; }
        .swatch-item.active { border: 2px solid #333; font-weight: bold; }
        .swatch-circle { width: 14px; height: 14px; border-radius: 50%; border: 1px solid #eee; margin-right: 6px; }
        
        .size-group { background: #fbfbfb; padding: 15px; border-radius: 4px; margin-bottom: 12px; border: 1px solid #f2f2f2; }
        .group-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 11px; font-weight: bold; }
        .s-btn-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
        .s-btn { border: 1px solid #ddd; background: #fff; padding: 8px 14px; cursor: pointer; font-size: 11px; border-radius: 2px; }
        .s-btn.active.babe { background: var(--baby-pink); color: #fff; border-color: var(--baby-pink); }
        .s-btn.active.kids { background: var(--kids-blue); color: #fff; border-color: var(--kids-blue); }

        /* 選中清單與數量 */
        .selected-list { margin: 20px 0; border-top: 1px solid #eee; }
        .selected-item { background: #f9f9f9; padding: 15px; margin-top: 10px; position: relative; border-radius: 4px; }
        .sel-close { position: absolute; top: 10px; right: 10px; width: 18px; cursor: pointer; opacity: 0.5; }
        .qty-box { display: flex; align-items: center; border: 1px solid #ddd; background: #fff; }
        .qty-btn { width: 30px; height: 30px; border: none; background: none; cursor: pointer; }
        .qty-input { width: 35px; text-align: center; border: none; font-size: 12px; font-weight: bold; }

        .add-cart-btn { width: 100%; padding: 18px; background: #111; color: #fff; border: none; font-size: 13px; font-weight: 700; letter-spacing: 2px; cursor: pointer; margin-top: 10px; }
        #custom-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: #fff; padding: 16px 32px; border-radius: 4px; font-size: 14px; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.3s; pointer-events: none; }
        #custom-toast.show { opacity: 1; visibility: visible; }

        @media (max-width: 900px) {
            .detail-wrapper { flex-direction: column; }
            .scroll-content { order: 1; padding: 15px; min-height: auto; }
            .fixed-aside { order: 2; width: 100%; position: relative; top: 0; padding: 30px 20px; border-top: 10px solid #f9f9f9; }
            .mobile-preview-box { display: flex; }
        }
    </style>
</head>
<body>

    <header class="top-header">
        <a href="javascript:history.back()" class="header-icon">BACK</a>
        <img src="images/ui/logo.png" class="main-logo" alt="AIFANG" onclick="location.href='index.html'">
        <a href="cart.html" class="header-icon">CART (<span id="cart-count">0</span>)</a>
    </header>

    <div class="detail-wrapper">
        <main class="scroll-content" id="image-main-area">
            <img id="primary-img" src="" alt="Loading...">
        </main>

        <aside class="fixed-aside" id="product-info">
            <span id="p-brand" class="brand-tag">-</span>
            <h1 id="p-title" class="p-title">載入中...</h1>
            <p id="p-id" class="p-id">CODE: -</p>

            <span class="label">COLOR / 顏色</span>
            <div id="mobile-preview-area" class="mobile-preview-box">
                <img id="mobile-color-preview-img" src="" alt="Color Preview">
                <div class="preview-info-text">
                    <span style="font-size:9px; color:#aaa;">SELECTED COLOR</span>
                    <span id="mobile-color-preview-name">請選擇花色</span>
                </div>
            </div>
            <div id="swatch-group" class="swatch-group"></div>

            <span class="label">SIZE / 尺寸價格</span>
            <div id="size-area"></div>

            <div id="selected-list" class="selected-list"></div>

            <button class="add-cart-btn" onclick="addAllToCart()">ADD TO CART</button>
            <p id="styling-note" style="margin-top:25px; font-size:12px; color:#888; line-height:1.7; white-space: pre-line;"></p>
        </aside>
    </div>

    <div id="custom-toast"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxnlAwKJucHmCKcJwv67TWuKV0X74Daag9X9I4NG7DOESREuYdU7BtWBPcEHyoJphoEfg/exec";
        let currentProduct = null;
        let selectedColor = null;
        let selections = [];

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (!code) { location.href = 'index.html'; return; }

            try {
                const res = await fetch(`${API_URL}?mode=product_detail&code=${code}`);
                const data = await res.json();
                if (data.success) {
                    currentProduct = data.product;
                    renderProduct(data.product);
                }
            } catch (e) { console.error("Error:", e); }
            updateCartCount();
        }

        function renderProduct(p) {
            document.getElementById('p-brand').innerText = p.brand;
            document.getElementById('p-title').innerText = p.name;
            document.getElementById('p-id').innerText = `CODE: ${p.code}`;
            document.getElementById('primary-img').src = p.image_main;
            document.getElementById('styling-note').innerText = p.styling_note || "";

            const isSale = (p.status || "").toUpperCase() === "SALE";

            // 詳細圖片
            if (p.images_detail) {
                const imgs = p.images_detail.split(',').filter(Boolean);
                imgs.forEach(url => {
                    const img = document.createElement('img');
                    img.src = url.trim();
                    document.getElementById('image-main-area').appendChild(img);
                });
            }

            // 顏色選取
            const cNames = (p.color || "").split(',').filter(Boolean);
            const cCodes = (p.color_code || "").split(',').filter(Boolean);
            const cPatterns = (p.color_pattern || "").split(',').filter(Boolean);
            const cPreviews = (p.color_preview || "").split(',').filter(Boolean);

            cNames.forEach((name, i) => {
                const item = document.createElement('div');
                item.className = 'swatch-item';
                const circle = document.createElement('div');
                circle.className = 'swatch-circle';
                
                if (cPatterns[i]) circle.style.backgroundImage = `url('${cPatterns[i].trim()}')`;
                else if (cCodes[i]) circle.style.backgroundColor = cCodes[i].trim();

                item.appendChild(circle);
                item.appendChild(document.createTextNode(name.trim()));
                item.onclick = () => {
                    document.querySelectorAll('.swatch-item').forEach(si => si.classList.remove('active'));
                    item.classList.add('active');
                    selectedColor = name.trim();
                    document.getElementById('mobile-color-preview-name').innerText = selectedColor;
                    if(cPreviews[i]) document.getElementById('mobile-color-preview-img').src = cPreviews[i].trim();
                };
                document.getElementById('swatch-group').appendChild(item);
            });

            // 尺寸價格 (7折邏輯修正)
            const groups = [
                { name: 'BABY', key: 'price_baby', sizes: p.size_baby, cls: 'babe' },
                { name: 'KIDS', key: 'price_kid', sizes: p.size_kid, cls: 'kids' },
                { name: 'JUNIOR', key: 'price_junior', sizes: p.size_junior, cls: 'kids' },
                { name: 'ADULT', key: 'price_adult', sizes: p.size_adult, cls: 'kids' }
            ];

            groups.forEach(g => {
                const sizes = (g.sizes || "").split(',').filter(Boolean);
                if (sizes.length > 0) {
                    const originPrice = Number(p[g.key] || 0);
                    // 修正：7折 = * 0.7
                    const finalPrice = isSale ? Math.ceil(originPrice * 0.7) : originPrice;

                    const div = document.createElement('div');
                    div.className = 'size-group';
                    
                    let priceHtml = `<span class="sale-price">NT$ ${finalPrice.toLocaleString()}</span>`;
                    if (isSale) {
                        priceHtml = `
                            <div class="price-row">
                                <div class="price-main">
                                    <span class="sale-price">NT$ ${finalPrice.toLocaleString()}</span>
                                    <span class="original-price">NT$ ${originPrice.toLocaleString()}</span>
                                </div>
                                <div class="sale-badge">SALE 30% OFF</div>
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        <div class="group-header"><span>${g.name}</span>${priceHtml}</div>
                        <div class="s-btn-wrap">
                            ${sizes.map(s => `<button class="s-btn" onclick="addSelection('${s.trim()}', ${finalPrice}, '${g.cls}')">${s.trim()}</button>`).join('')}
                        </div>
                    `;
                    document.getElementById('size-area').appendChild(div);
                }
            });
        }

        function addSelection(size, price, cls) {
            if (!selectedColor) { showToast("請先選擇顏色！"); return; }
            const key = `${selectedColor}-${size}`;
            const exists = selections.find(s => s.key === key);
            if (exists) { exists.qty++; } 
            else { selections.push({ key, color: selectedColor, size, price, qty: 1 }); }
            renderSelections();
        }

        function renderSelections() {
            const box = document.getElementById('selected-list');
            box.innerHTML = selections.map((s, idx) => `
                <div class="selected-item">
                    <img src="images/ui/close.png" class="sel-close" onclick="selections.splice(${idx}, 1); renderSelections();">
                    <div style="font-size:12px; margin-bottom:10px;">${s.color} / ${s.size}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="qty-box">
                            <button class="qty-btn" onclick="updateQty(${idx},-1)">-</button>
                            <input class="qty-input" value="${s.qty}" readonly>
                            <button class="qty-btn" onclick="updateQty(${idx},1)">+</button>
                        </div>
                        <div style="font-weight:bold;">NT$ ${(s.price * s.qty).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateQty(idx, d) {
            selections[idx].qty = Math.max(1, selections[idx].qty + d);
            renderSelections();
        }

        function addAllToCart() {
            if (selections.length === 0) { showToast("請選擇尺寸"); return; }
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            selections.forEach(s => {
                const cartKey = `${currentProduct.code}-${s.color}-${s.size}`;
                const exists = cart.find(i => i.cartKey === cartKey);
                if (exists) exists.quantity += s.qty;
                else cart.push({ cartKey, id: currentProduct.code, name: currentProduct.name, color: s.color, size: s.size, price: s.price, image: currentProduct.image_main, quantity: s.qty });
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            showToast("已加入購物車");
            selections = []; renderSelections(); updateCartCount();
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            document.getElementById('cart-count').innerText = cart.reduce((a, b) => a + b.quantity, 0);
        }

        function showToast(msg) {
            const t = document.getElementById('custom-toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        window.onload = init;
    </script>
</body>
</html>