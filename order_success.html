<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Success | AiFang Kids</title>
    <style>
        :root { --accent: #06C755; --dark: #111; --gray: #fcfcfc; --border: #eeeeee; --sale-red: #e74c3c; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #fff; color: #333; line-height: 1.6; padding: 40px 20px; }
        
        .container { max-width: 500px; margin: 0 auto; }
        
        .header-status { text-align: center; margin-bottom: 40px; }
        .success-icon { 
            width: 60px; height: 60px; background: var(--accent); color: #fff; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 30px; margin: 0 auto 15px; 
            box-shadow: 0 10px 20px rgba(6, 199, 85, 0.2);
        }
        h1 { font-size: 20px; letter-spacing: 3px; font-weight: 600; text-transform: uppercase; }
        .sub-msg { font-size: 13px; color: #888; margin-top: 5px; }

        .receipt { 
            background: var(--gray); border: 1px solid var(--border); 
            padding: 30px; position: relative; border-radius: 4px; overflow: hidden;
        }
        
        .info-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .info-section:last-of-type { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        .info-title { font-size: 11px; font-weight: bold; color: #bbb; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .info-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
        .info-row span:first-child { color: #777; }
        .info-row .val { font-weight: 500; text-align: right; color: #111; }

        /* SALE æ¨™ç±¤æ¨£å¼ */
        .sale-badge {
            background: var(--sale-red); color: #fff; font-size: 9px; 
            padding: 1px 4px; border-radius: 2px; margin-right: 4px;
            font-weight: bold; vertical-align: middle;
        }

        /* é–æ­»é‡‘é¡æé†’ */
        #sale-alert-box {
            display: none; background: #fff5f5; border: 1px solid #ffe3e3;
            color: var(--sale-red); padding: 10px; border-radius: 4px;
            font-size: 11px; margin-bottom: 15px; text-align: center;
        }

        .item-list { margin-top: 10px; background: #fff; border: 1px solid #f0f0f0; padding: 15px; border-radius: 2px; }
        .item-row { font-size: 13px; display: flex; justify-content: space-between; margin-bottom: 12px; line-height: 1.4; border-bottom: 1px dotted #f0f0f0; padding-bottom: 8px; }
        .item-row:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }

        .line-notice { 
            background: #f0fdf4; border: 1px solid #dcfce7; color: #166534; 
            padding: 20px; border-radius: 4px; font-size: 13px; margin: 30px 0; 
            text-align: center; line-height: 1.8;
        }

        .btn-line { 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background: var(--accent); color: #fff; text-align: center; padding: 20px; 
            text-decoration: none; border-radius: 4px; font-weight: bold; 
            letter-spacing: 1px; cursor: pointer; border: none; width: 100%; font-size: 16px; 
            transition: 0.3s;
        }
        .btn-line:hover { background: #05b34c; transform: translateY(-2px); }
        .btn-line img { width: 20px; height: 20px; }

        .btn-home { display: block; text-align: center; margin-top: 30px; font-size: 12px; color: #aaa; text-decoration: none; letter-spacing: 1px; }
        .btn-home:hover { color: #333; text-decoration: underline; }

        @media (max-width: 480px) {
            .receipt { padding: 20px; }
            .info-row { font-size: 13px; }
            h1 { font-size: 18px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-status">
        <div class="success-icon">âœ“</div>
        <h1>ORDER RECEIVED</h1>
        <p class="sub-msg">æ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼Œæˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„éœ€æ±‚ï¼</p>
    </div>

    <div class="receipt">
        <div id="sale-alert-box">ğŸ’¡ æé†’ï¼šæ‚¨çš„è¨‚å–®åŒ…å« SALE å•†å“ï¼Œé‡‘é¡å·²ç‚ºæœ€çµ‚ç‰¹æƒ åƒ¹ã€‚</div>

        <div class="info-section">
            <span class="info-title">Summary è¨‚å–®æ‘˜è¦</span>
            <div class="info-row"><span>è¨‚å–®ç·¨è™Ÿ:</span> <span class="val" id="order-id">-</span></div>
            <div class="info-row"><span>ä»˜æ¬¾æ–¹å¼:</span> <span class="val" id="order-pay">-</span></div>
            <div class="info-row"><span>æ‡‰ä»˜ç¸½é¡:</span> <span class="val" id="order-total" style="color: #d9534f; font-weight: 700;">-</span></div>
        </div>

        <div class="info-section">
            <span class="info-title">Shipping æ”¶ä»¶è³‡è¨Š</span>
            <div class="info-row"><span>æ”¶ä»¶äºº:</span> <span class="val" id="cust-name">-</span></div>
            <div class="info-row"><span>é…é€åœ°å€:</span> <span class="val" id="cust-addr" style="max-width: 65%;"> -</span></div>
        </div>

        <div class="info-section">
            <span class="info-title">Details è¨‚è³¼æ˜ç´°</span>
            <div id="item-list" class="item-list"></div>
        </div>
    </div>

    <div class="line-notice">
        <strong>ğŸ’¡ æœ€å¾Œä¸€æ­¥ï¼šå®Œæˆé€šçŸ¥</strong><br>
        è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç³»çµ±å°‡è‡ªå‹•è¤‡è£½è¨‚å–®å…§å®¹ä¸¦é–‹å•Ÿ LINEï¼Œ<br>è«‹åœ¨å°è©±æ¡†ã€Œè²¼ä¸Šä¸¦å‚³é€ã€å³å¯å®Œæˆï¼
    </div>

    <button id="line-link" class="btn-line">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/LINE_logo.svg" alt="LINE">
        é»æˆ‘è¤‡è£½è¨‚å–®ä¸¦è¯çµ¡ LINE å®¢æœ
    </button>
    
    <a href="index.html" class="btn-home">â† BACK TO SHOPPING ç¹¼çºŒè³¼ç‰©</a>
</div>

<textarea id="copy-helper" style="position: absolute; left: -9999px; top: 0;" readonly></textarea>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const orderData = JSON.parse(localStorage.getItem('last_order_info'));
        
        if (!orderData) {
            alert("æ‰¾ä¸åˆ°è¨‚å–®è³‡è¨Šï¼Œå°‡ç‚ºæ‚¨è¿”å›é¦–é ã€‚");
            window.location.href = 'index.html';
            return;
        }

        // 1. å¡«å…¥åŸºæœ¬è³‡è¨Š (ä¿®æ­£ï¼šåŠ å…¥æ•¸å€¼å¼·åˆ¶è½‰æ›)
        document.getElementById('order-id').innerText = orderData.id || "-";
        document.getElementById('order-pay').innerText = orderData.pay_method_text || "-";
        
        // å¼·åˆ¶è½‰æ›ç¸½é¡ç‚ºæ•¸å­—ä»¥é˜²å‡ºç¾ NaN
        const totalAmt = Number(orderData.total_amount) || 0;
        document.getElementById('order-total').innerText = "NT$ " + totalAmt.toLocaleString();
        
        document.getElementById('cust-name').innerText = orderData.customer_name || "-";
        document.getElementById('cust-addr').innerText = orderData.customer_address || "-";

        // 2. æ¸²æŸ“æ˜ç´°èˆ‡åµæ¸¬ SALE ç‹€æ…‹
        if (orderData.items) {
            let hasSale = false;
            const listHtml = orderData.items.map(item => {
                // æª¢æŸ¥æ˜¯å¦ç‚º SALE å•†å“
                const isSale = (item.status || "").toString().trim().toUpperCase() === 'SALE';
                if (isSale) hasSale = true;

                // ä¿®æ­£ï¼šç¢ºä¿å–®åƒ¹èˆ‡æ•¸é‡ç‚ºæ•¸å­—ï¼Œé¿å…è¨ˆç®—å‡ºéæ•¸å€¼
                const price = Number(item.unit_price) || 0;
                const qty = Number(item.quantity) || 0;
                const rowTotal = price * qty;

                return `
                    <div class="item-row">
                        <div style="color:#666;">
                            <div style="margin-bottom:2px; color:#111; font-weight:500;">
                                ${isSale ? '<span class="sale-badge">SALE</span>' : ''}
                                ${item.product_name || item.name}
                            </div>
                            <small>${item.color} / ${item.size} x ${qty}</small>
                        </div>
                        <div style="color: #111; font-weight:700;">NT$ ${rowTotal.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('item-list').innerHTML = listHtml;

            // å¦‚æœæœ‰ SALE å•†å“ï¼Œé¡¯ç¤ºæé†’å€å¡Š
            if (hasSale) {
                document.getElementById('sale-alert-box').style.display = 'block';
            }
        }

        // 3. è™•ç† LINE è¤‡è£½è·³è½‰é‚è¼¯
        const lineBtn = document.getElementById('line-link');
        const copyHelper = document.getElementById('copy-helper');
        
        lineBtn.addEventListener('click', async () => {
            const msg = orderData.line_msg || "";
            copyHelper.value = msg;

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(msg);
                } else {
                    copyHelper.select();
                    document.execCommand('copy');
                }
                
                const originalContent = lineBtn.innerHTML;
                lineBtn.innerHTML = "âœ… è¨‚å–®å…§å®¹å·²è¤‡è£½ï¼æ­£åœ¨é–‹å•Ÿ LINE...";
                lineBtn.style.background = "#333";

                setTimeout(() => {
                    const encodedMsg = encodeURIComponent(msg);
                    const lineUrl = "https://line.me/R/oaMessage/@844bwwjl/?" + encodedMsg;
                    window.location.href = lineUrl;
                    
                    setTimeout(() => {
                        lineBtn.innerHTML = originalContent;
                        lineBtn.style.background = "var(--accent)";
                    }, 3000);
                }, 1000);

            } catch (err) {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–æ­¤é é¢å‚³é€çµ¦å®¢æœã€‚");
            }
        });
    });
</script>

</body>
</html>